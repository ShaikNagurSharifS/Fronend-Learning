name: CI - Playwright + k6

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    playwright-tests:
        name: Playwright tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [20]
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
            - name: Install dependencies
              run: npm ci
            - name: Install Playwright browsers
              run: npx playwright install --with-deps
            - name: Run Playwright smoke tests
              run: npm run test:ci-smoke

    k6-load-test:
        name: k6 performance tests
        runs-on: ubuntu-latest
        needs: playwright-tests
        steps:
            - uses: actions/checkout@v4
            - name: Install k6 on runner
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gnupg2
                  curl -s https://dl.k6.io/key.gpg | sudo apt-key add -
                  echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
                  sudo apt-get update
                  sudo apt-get install -y k6
            - name: Run k6 load script
              run: |
                  if [ -f performance/k6/load-test.js ]; then
                    k6 run performance/k6/load-test.js
                  else
                    echo "No k6 load-test.js found - skipping";
                  fi

#   zap-scan-local-note:
#     name: ZAP DAST (manual/local)
#     runs-on: ubuntu-latest
#     if: false
#     steps:
#       - name: Note
#         run: |
#           echo "This job is intentionally disabled. Run OWASP ZAP locally or in a dedicated environment."
#           echo "For CI, enable a ZAP container or use the community ZAP GH Action and configure targets/secrets."
